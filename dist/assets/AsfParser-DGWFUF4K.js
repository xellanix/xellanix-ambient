import{u as H,h as P,s as V,e as $,f as b,j as o,k as E,m as W,l as A,S as h,A as J,B as q,c as R,T as z}from"./index-CYC54ARG.js";class e{static fromBin(t,a=0){return new e(e.decode(t,a))}static decode(t,a=0){const r=new DataView(t.buffer,a);return`${r.getUint32(0,!0).toString(16)}-${r.getUint16(4,!0).toString(16)}-${r.getUint16(6,!0).toString(16)}-${r.getUint16(8).toString(16)}-${H(t.slice(a+10,a+16))}`.toUpperCase()}static decodeMediaType(t){switch(t.str){case e.AudioMedia.str:return"audio";case e.VideoMedia.str:return"video";case e.CommandMedia.str:return"command";case e.Degradable_JPEG_Media.str:return"degradable-jpeg";case e.FileTransferMedia.str:return"file-transfer";case e.BinaryMedia.str:return"binary"}}static encode(t){const a=new Uint8Array(16),r=new DataView(a.buffer);return r.setUint32(0,Number.parseInt(t.slice(0,8),16),!0),r.setUint16(4,Number.parseInt(t.slice(9,13),16),!0),r.setUint16(6,Number.parseInt(t.slice(14,18),16),!0),a.set(P(t.slice(19,23)),8),a.set(P(t.slice(24)),10),a}constructor(t){this.str=t}equals(t){return this.str===t.str}toBin(){return e.encode(this.str)}}e.HeaderObject=new e("75B22630-668E-11CF-A6D9-00AA0062CE6C");e.DataObject=new e("75B22636-668E-11CF-A6D9-00AA0062CE6C");e.SimpleIndexObject=new e("33000890-E5B1-11CF-89F4-00A0C90349CB");e.IndexObject=new e("D6E229D3-35DA-11D1-9034-00A0C90349BE");e.MediaObjectIndexObject=new e("FEB103F8-12AD-4C64-840F-2A1D2F7AD48C");e.TimecodeIndexObject=new e("3CB73FD0-0C4A-4803-953D-EDF7B6228F0C");e.FilePropertiesObject=new e("8CABDCA1-A947-11CF-8EE4-00C00C205365");e.StreamPropertiesObject=new e("B7DC0791-A9B7-11CF-8EE6-00C00C205365");e.HeaderExtensionObject=new e("5FBF03B5-A92E-11CF-8EE3-00C00C205365");e.CodecListObject=new e("86D15240-311D-11D0-A3A4-00A0C90348F6");e.ScriptCommandObject=new e("1EFB1A30-0B62-11D0-A39B-00A0C90348F6");e.MarkerObject=new e("F487CD01-A951-11CF-8EE6-00C00C205365");e.BitrateMutualExclusionObject=new e("D6E229DC-35DA-11D1-9034-00A0C90349BE");e.ErrorCorrectionObject=new e("75B22635-668E-11CF-A6D9-00AA0062CE6C");e.ContentDescriptionObject=new e("75B22633-668E-11CF-A6D9-00AA0062CE6C");e.ExtendedContentDescriptionObject=new e("D2D0A440-E307-11D2-97F0-00A0C95EA850");e.ContentBrandingObject=new e("2211B3FA-BD23-11D2-B4B7-00A0C955FC6E");e.StreamBitratePropertiesObject=new e("7BF875CE-468D-11D1-8D82-006097C9A2B2");e.ContentEncryptionObject=new e("2211B3FB-BD23-11D2-B4B7-00A0C955FC6E");e.ExtendedContentEncryptionObject=new e("298AE614-2622-4C17-B935-DAE07EE9289C");e.DigitalSignatureObject=new e("2211B3FC-BD23-11D2-B4B7-00A0C955FC6E");e.PaddingObject=new e("1806D474-CADF-4509-A4BA-9AABCB96AAE8");e.ExtendedStreamPropertiesObject=new e("14E6A5CB-C672-4332-8399-A96952065B5A");e.AdvancedMutualExclusionObject=new e("A08649CF-4775-4670-8A16-6E35357566CD");e.GroupMutualExclusionObject=new e("D1465A40-5A79-4338-B71B-E36B8FD6C249");e.StreamPrioritizationObject=new e("D4FED15B-88D3-454F-81F0-ED5C45999E24");e.BandwidthSharingObject=new e("A69609E6-517B-11D2-B6AF-00C04FD908E9");e.LanguageListObject=new e("7C4346A9-EFE0-4BFC-B229-393EDE415C85");e.MetadataObject=new e("C5F8CBEA-5BAF-4877-8467-AA8C44FA4CCA");e.MetadataLibraryObject=new e("44231C94-9498-49D1-A141-1D134E457054");e.IndexParametersObject=new e("D6E229DF-35DA-11D1-9034-00A0C90349BE");e.MediaObjectIndexParametersObject=new e("6B203BAD-3F11-48E4-ACA8-D7613DE2CFA7");e.TimecodeIndexParametersObject=new e("F55E496D-9797-4B5D-8C8B-604DFE9BFB24");e.CompatibilityObject=new e("26F18B5D-4584-47EC-9F5F-0E651F0452C9");e.AdvancedContentEncryptionObject=new e("43058533-6981-49E6-9B74-AD12CB86D58C");e.AudioMedia=new e("F8699E40-5B4D-11CF-A8FD-00805F5C442B");e.VideoMedia=new e("BC19EFC0-5B4D-11CF-A8FD-00805F5C442B");e.CommandMedia=new e("59DACFC0-59E6-11D0-A3AC-00A0C90348F6");e.JFIF_Media=new e("B61BE100-5B4E-11CF-A8FD-00805F5C442B");e.Degradable_JPEG_Media=new e("35907DE0-E415-11CF-A917-00805F5C442B");e.FileTransferMedia=new e("91BD222C-F21C-497A-8B6D-5AA86BFC0185");e.BinaryMedia=new e("3AFB65E2-47EF-40F2-AC2C-70A90D71D343");e.ASF_Index_Placeholder_Object=new e("D9AADE20-7C17-4F9C-BC28-8555DD98E2A2");function _(n){return Q[n]}function p(n){return V($(n,"utf-16le"))}const Q=[p,M,K,X,Y,N,M];function M(n){return new Uint8Array(n)}function K(n,t=0){return N(n,t)===1}function X(n,t=0){return b.get(n,t)}function Y(n,t=0){return o.get(n,t)}function N(n,t=0){return E.get(n,t)}class L extends W("ASF"){}const Z={len:30,get:(n,t)=>({objectId:e.fromBin(n,t),objectSize:Number(o.get(n,t+16)),numberOfHeaderObjects:b.get(n,t+24)})},g={len:24,get:(n,t)=>({objectId:e.fromBin(n,t),objectSize:Number(o.get(n,t+16))})};class l{constructor(t){this.len=Number(t.objectSize)-g.len}postProcessTag(t,a,r,s){if(a==="WM/Picture")t.push({id:a,value:I.fromBuffer(s)});else{const c=_(r);if(!c)throw new L(`unexpected value headerType: ${r}`);t.push({id:a,value:c(s)})}}}class U extends l{get(t,a){return null}}class O extends l{get(t,a){return{fileId:e.fromBin(t,a),fileSize:o.get(t,a+16),creationDate:o.get(t,a+24),dataPacketsCount:o.get(t,a+32),playDuration:o.get(t,a+40),sendDuration:o.get(t,a+48),preroll:o.get(t,a+56),flags:{broadcast:A(t,a+64,24),seekable:A(t,a+64,25)},minimumDataPacketSize:b.get(t,a+68),maximumDataPacketSize:b.get(t,a+72),maximumBitrate:b.get(t,a+76)}}}O.guid=e.FilePropertiesObject;class T extends l{get(t,a){return{streamType:e.decodeMediaType(e.fromBin(t,a)),errorCorrectionType:e.fromBin(t,a+8)}}}T.guid=e.StreamPropertiesObject;class k{constructor(){this.len=22}get(t,a){const r=new DataView(t.buffer,a);return{reserved1:e.fromBin(t,a),reserved2:r.getUint16(16,!0),extensionDataSize:r.getUint16(18,!0)}}}k.guid=e.HeaderExtensionObject;const G={len:20,get:(n,t)=>({entryCount:new DataView(n.buffer,t).getUint16(16,!0)})};async function v(n){const t=await n.readNumber(E);return(await n.readToken(new h(t*2,"utf-16le"))).replace("\0","")}async function f(n){const t=await n.readToken(G),a=[];for(let r=0;r<t.entryCount;++r)a.push(await te(n));return a}async function ee(n){const t=await n.readNumber(E),a=new Uint8Array(t);return await n.readBuffer(a),a}async function te(n){const t=await n.readNumber(E);return{type:{videoCodec:(t&1)===1,audioCodec:(t&2)===2},codecName:await v(n),description:await v(n),information:await ee(n)}}class w extends l{get(t,a){const r=[],s=new DataView(t.buffer,a);let c=10;for(let i=0;i<w.contentDescTags.length;++i){const d=s.getUint16(i*2,!0);if(d>0){const u=w.contentDescTags[i],C=c+d;r.push({id:u,value:p(t.slice(a+c,a+C))}),c=C}}return r}}w.guid=e.ContentDescriptionObject;w.contentDescTags=["Title","Author","Copyright","Description","Rating"];class x extends l{get(t,a){const r=[],s=new DataView(t.buffer,a),c=s.getUint16(0,!0);let i=2;for(let d=0;d<c;d+=1){const u=s.getUint16(i,!0);i+=2;const C=p(t.slice(a+i,a+i+u));i+=u;const m=s.getUint16(i,!0);i+=2;const D=s.getUint16(i,!0);i+=2;const j=t.slice(a+i,a+i+D);i+=D,this.postProcessTag(r,C,m,j)}return r}}x.guid=e.ExtendedContentDescriptionObject;class y extends l{get(t,a){const r=new DataView(t.buffer,a);return{startTime:o.get(t,a),endTime:o.get(t,a+8),dataBitrate:r.getInt32(12,!0),bufferSize:r.getInt32(16,!0),initialBufferFullness:r.getInt32(20,!0),alternateDataBitrate:r.getInt32(24,!0),alternateBufferSize:r.getInt32(28,!0),alternateInitialBufferFullness:r.getInt32(32,!0),maximumObjectSize:r.getInt32(36,!0),flags:{reliableFlag:A(t,a+40,0),seekableFlag:A(t,a+40,1),resendLiveCleanpointsFlag:A(t,a+40,2)},streamNumber:r.getInt16(42,!0),streamLanguageId:r.getInt16(44,!0),averageTimePerFrame:r.getInt32(52,!0),streamNameCount:r.getInt32(54,!0),payloadExtensionSystems:r.getInt32(56,!0),streamNames:[],streamPropertiesObject:null}}}y.guid=e.ExtendedStreamPropertiesObject;class F extends l{get(t,a){const r=[],s=new DataView(t.buffer,a),c=s.getUint16(0,!0);let i=2;for(let d=0;d<c;d+=1){i+=4;const u=s.getUint16(i,!0);i+=2;const C=s.getUint16(i,!0);i+=2;const m=s.getUint32(i,!0);i+=4;const D=p(t.slice(a+i,a+i+u));i+=u;const j=t.slice(a+i,a+i+m);i+=m,this.postProcessTag(r,D,C,j)}return r}}F.guid=e.MetadataObject;class S extends F{}S.guid=e.MetadataLibraryObject;class I{static fromBuffer(t){return new I(t.length).get(t,0)}constructor(t){this.len=t}get(t,a){const r=new DataView(t.buffer,a),s=r.getUint8(0),c=r.getInt32(1,!0);let i=5;for(;r.getUint16(i)!==0;)i+=2;const d=new h(i-5,"utf-16le").get(t,5);for(;r.getUint16(i)!==0;)i+=2;const u=new h(i-5,"utf-16le").get(t,5);return{type:J[s],format:d,description:u,size:c,data:t.slice(i+4)}}}const B=R("music-metadata:parser:ASF"),ae="asf";class ne extends q{async parse(){const t=await this.tokenizer.readToken(Z);if(!t.objectId.equals(e.HeaderObject))throw new L(`expected asf header; but was not found; got: ${t.objectId.str}`);try{await this.parseObjectHeader(t.numberOfHeaderObjects)}catch(a){B("Error while parsing ASF: %s",a)}}async parseObjectHeader(t){let a;do{const r=await this.tokenizer.readToken(g);switch(B("header GUID=%s",r.objectId.str),r.objectId.str){case O.guid.str:{const s=await this.tokenizer.readToken(new O(r));this.metadata.setFormat("duration",Number(s.playDuration/BigInt(1e3))/1e4-Number(s.preroll)/1e3),this.metadata.setFormat("bitrate",s.maximumBitrate);break}case T.guid.str:{const s=await this.tokenizer.readToken(new T(r));this.metadata.setFormat("container",`ASF/${s.streamType}`);break}case k.guid.str:{const s=await this.tokenizer.readToken(new k);await this.parseExtensionObject(s.extensionDataSize);break}case w.guid.str:a=await this.tokenizer.readToken(new w(r)),await this.addTags(a);break;case x.guid.str:a=await this.tokenizer.readToken(new x(r)),await this.addTags(a);break;case e.CodecListObject.str:{const s=await f(this.tokenizer);s.forEach(i=>{this.metadata.addStreamInfo({type:i.type.videoCodec?z.video:z.audio,codecName:i.codecName})});const c=s.filter(i=>i.type.audioCodec).map(i=>i.codecName).join("/");this.metadata.setFormat("codec",c);break}case e.StreamBitratePropertiesObject.str:await this.tokenizer.ignore(r.objectSize-g.len);break;case e.PaddingObject.str:B("Padding: %s bytes",r.objectSize-g.len),await this.tokenizer.ignore(r.objectSize-g.len);break;default:this.metadata.addWarning(`Ignore ASF-Object-GUID: ${r.objectId.str}`),B("Ignore ASF-Object-GUID: %s",r.objectId.str),await this.tokenizer.readToken(new U(r))}}while(--t)}async addTags(t){await Promise.all(t.map(({id:a,value:r})=>this.metadata.addTag(ae,a,r)))}async parseExtensionObject(t){do{const a=await this.tokenizer.readToken(g),r=a.objectSize-g.len;switch(a.objectId.str){case y.guid.str:await this.tokenizer.readToken(new y(a));break;case F.guid.str:{const s=await this.tokenizer.readToken(new F(a));await this.addTags(s);break}case S.guid.str:{const s=await this.tokenizer.readToken(new S(a));await this.addTags(s);break}case e.PaddingObject.str:await this.tokenizer.ignore(r);break;case e.CompatibilityObject.str:await this.tokenizer.ignore(r);break;case e.ASF_Index_Placeholder_Object.str:await this.tokenizer.ignore(r);break;default:this.metadata.addWarning(`Ignore ASF-Object-GUID: ${a.objectId.str}`),await this.tokenizer.readToken(new U(a));break}t-=a.objectSize}while(t>0)}}export{ne as AsfParser};
